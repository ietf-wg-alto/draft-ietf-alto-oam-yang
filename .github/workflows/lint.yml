name: "Validate YANG Modules"

on:
  push:
    paths:
    - '**.yang'
    - '.github/workflows/lint.yml'
  pull_request:
    paths:
    - '**.yang'
    - '.github/workflows/lint.yml'

jobs:
  validate-yang:
    name: "Validate YANG modules (${{ matrix.validation-mode }} mode)"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        validation-mode: [api, local]
      fail-fast: false
    steps:
    - name: "Checkout"
      uses: actions/checkout@v5

    - name: "Install dependencies"
      run: |
        # Install Ruby gems for i-d-template (kramdown-rfc)
        gem install kramdown-rfc --user-install --no-document
        
        # Add gem bin directory to PATH (gem installs to ~/.local/share/gem)
        echo "$HOME/.local/share/gem/ruby/3.2.0/bin" >> $GITHUB_PATH
        
        # Install Python tools needed for draft generation
        pip install xml2rfc

    - name: "Generate draft"
      run: |
        # Generate the draft file (this embeds YANG modules with xym tags)
        make

    - name: "Validate YANG modules using fno2010/ietf-yang-validator"
      uses: fno2010/ietf-yang-validator@v1.2
      with:
        source: "draft-ietf-alto-oam-yang.txt"
        validation-mode: "${{ matrix.validation-mode }}"
        validators: ${{ matrix.validation-mode == 'local' && 'pyang,yanglint' || '' }}
        fail-on-errors: "true"

    - name: "Display validation summary"
      run: |
        # Find the most recent validation report
        REPORT_FILE=$(ls -t validation_report_*.json | head -1)
        
        if [ -f "$REPORT_FILE" ]; then
          echo "## Validation Summary (${{ matrix.validation-mode }} mode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          jq '.summary' "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "No validation report found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: "Upload validation report"
      uses: actions/upload-artifact@v4
      with:
        name: yang-validation-report-${{ matrix.validation-mode }}
        path: validation_report_*.json
        retention-days: 30
