name: "Validate YANG Modules"

on:
  push:
    paths:
    - '**.yang'
    - '.github/workflows/lint.yml'
  pull_request:
    paths:
    - '**.yang'
    - '.github/workflows/lint.yml'

jobs:
  yang-catalog:
    name: "Validate using YANG Catalog API"
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout"
      uses: actions/checkout@v5

    - name: "Install dependencies"
      run: |
        # Install Ruby gems for i-d-template (kramdown-rfc)
        gem install kramdown-rfc --user-install --no-document
        
        # Add gem bin directory to PATH (gem installs to ~/.local/share/gem)
        echo "$HOME/.local/share/gem/ruby/3.2.0/bin" >> $GITHUB_PATH
        
        # Install Python tools needed for draft generation
        pip install xml2rfc

    - name: "Generate draft"
      run: |
        # Generate the draft file (this embeds YANG modules with xym tags)
        make

    - name: "Validate using YANG Catalog API"
      id: yang-catalog-validate
      run: |
        # Make the script executable
        chmod +x ./tools/yang-validator-api.sh

        # Capture output and exit code
        set +e
        ./tools/yang-validator-api.sh draft-ietf-alto-oam-yang.txt > yang_catalog_output.txt 2>&1
        CATALOG_EXIT=$?
        set -e

        # Display results
        if [ $CATALOG_EXIT -eq 0 ]; then
          echo "✅ All YANG modules passed validation (YANG Catalog API)"
          echo "## Summary (YANG Catalog API)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All YANG modules passed validation using YANG Catalog API**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This validation uploads the draft and extracts YANG modules using xym." >> $GITHUB_STEP_SUMMARY
          echo "It uses the latest dependencies from the YANG Catalog database." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat yang_catalog_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some YANG modules failed validation (YANG Catalog API)"
          echo "## Summary (YANG Catalog API)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ **Some YANG modules failed validation using YANG Catalog API**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This validation uploads the draft and extracts YANG modules using xym." >> $GITHUB_STEP_SUMMARY
          echo "It uses the latest dependencies from the YANG Catalog database." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat yang_catalog_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

        # Always show the output
        cat yang_catalog_output.txt

        # Exit with original code to not fail the step
        exit $CATALOG_EXIT
